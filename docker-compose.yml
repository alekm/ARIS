services:
  redis:
    container_name: aris-redis
    image: redis:7-alpine
    # Redis port removed from host exposure for security
    # Services access via internal Docker network
    volumes:
      - ./data/redis:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - redis-cli
        - ping
      interval: 10s
      timeout: 5s
      retries: 5
  audio-capture:
    container_name: aris-audio-capture
    build:
      context: .
      dockerfile: ./services/audio-capture/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./data/audio:/data/audio
      - ./services/audio-capture/config.yaml:/app/config.yaml
      - ./services/audio-capture:/app
      - ./shared:/app/shared
    environment:
      - REDIS_PORT=${REDIS_PORT:-6379}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Note: Slots are configured via Web UI or API, not environment variables
      # To enable auto-start of slot 1, set MODE=kiwi and KIWI_HOST in .env file
      # - MODE=${MODE:-}
      # - KIWI_HOST=${KIWI_HOST:-}
      # - KIWI_PORT=${KIWI_PORT:-8073}
      # - FREQUENCY_HZ=${FREQUENCY_HZ:-7200000}
    restart: unless-stopped
  stt:
    container_name: aris-stt
    build:
      context: .
      dockerfile: ./services/stt/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./data/transcripts:/data/transcripts
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - MODEL_SIZE=${MODEL_SIZE:-medium} # tiny, base, small, medium, large-v2, large-v3
      - DEVICE=${DEVICE:-cuda} # cuda or cpu
      - ENABLE_TRANSLATION=${ENABLE_TRANSLATION:-false} # Enable auto-detect and translate to English
      - VAD_THRESHOLD=${VAD_THRESHOLD:-0.5}
      - ENERGY_THRESHOLD=${ENERGY_THRESHOLD:-0.01} # Minimum confidence for publishing transcripts (0.0-1.0)
      - STT_MIN_CONFIDENCE=${STT_MIN_CONFIDENCE:-0.4}
      - LOG_LEVEL=${LOG_LEVEL:-WARNING}
      - HF_TOKEN=${HF_TOKEN}
      # Redirect Hugging Face caches/logs to writable volume
      - HF_HUB_CACHE=/data/models
      - XDG_CACHE_HOME=/data/cache
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids:
                - "1"
              capabilities:
                - gpu
    restart: unless-stopped
  callsign-extractor:
    container_name: aris-callsign-extractor
    build:
      context: .
      dockerfile: ./services/callsign-extractor/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - LOG_LEVEL=${LOG_LEVEL:-WARNING}
    restart: unless-stopped
  summarizer:
    container_name: aris-summarizer
    build:
      context: .
      dockerfile: ./services/summarizer/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./data/summaries:/data/summaries
      - ./data/db:/data/db
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - DATABASE_URL=${DATABASE_URL:-sqlite:////data/db/aris.db}
      - LLM_BACKEND=${LLM_BACKEND:-ollama} # ollama, llama-cpp, or openai-compatible
      - LLM_MODEL=${LLM_MODEL:-llama3.2:latest}
      - LLM_HOST=${LLM_HOST:-host.docker.internal:11434} # Adjust for your LLM server
      - LLM_API_KEY=${LLM_API_KEY:-}
      - LOG_LEVEL=${LOG_LEVEL:-WARNING}
    extra_hosts:
      - host.docker.internal:host-gateway
    restart: unless-stopped
  web:
    container_name: aris-web
    build:
      context: ./services/web
      dockerfile: Dockerfile
    ports:
      - 3000:5173
    volumes:
      - ./services/web:/app
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true # Ensure file changes are detected
    depends_on:
      - api
    restart: unless-stopped
  api:
    container_name: aris-api
    build:
      context: .
      dockerfile: ./services/api/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./data/db:/data/db
    # API port not exposed by default for security
    # Uncomment below to expose API for troubleshooting:
    ports:
      - 8000:8000
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - DATABASE_URL=${DATABASE_URL:-sqlite:////data/db/aris.db}
      - API_PORT=8000
      - API_HOST=${API_HOST:-0.0.0.0}
      - LOG_LEVEL=${LOG_LEVEL:-WARNING}
      - ARIS_ADMIN_PASSWORD=${ARIS_ADMIN_PASSWORD}
      - ARIS_SECRET_KEY=${ARIS_SECRET_KEY}
      # Optional API key for automation clients
      - API_KEY=${API_KEY:-}
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8000/api/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
volumes:
  redis-data: null
networks: {}
